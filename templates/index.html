{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Outbound Caller ID Update</h2>

  <!-- SINGLE UPDATE -->
  <div class="card mb-4">
    <div class="card-header">Single Update</div>
    <div class="card-body">
      <form id="singleUpdateForm">
        <div class="row align-items-end">
          <div class="col-md-3 mb-2">
            <select class="form-select" name="update_type" id="singleUpdateType">
              <option value="email" selected>By Email ID</option>
              <option value="extension_id">By Extension ID</option>
              <option value="extension_number">By Extension Number</option>
            </select>
          </div>
          <div class="col-md-3 mb-2">
            <input type="text" class="form-control" name="identifier" id="singleIdentifier"
              placeholder="Email ID or Extension" required>
          </div>
          <div class="col-md-3 mb-2">
            <input type="text" class="form-control" name="caller_id" id="caller_id"
              placeholder="Caller ID (+E.164)" required>
          </div>
          <div class="col-md-2 mb-2">
            <input type="text" class="form-control" name="alias" id="alias"
              placeholder="Alias (optional)">
          </div>
          <div class="col-md-1 mb-2">
            <button type="submit" id="singleUpdateBtn" class="btn btn-primary w-100">Update</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- BULK UPDATE -->
  <div class="card mb-4">
    <div class="card-header">Bulk Update (Excel)</div>
    <div class="card-body">
      <form id="bulkUpdateForm" enctype="multipart/form-data">
        <div class="row align-items-end">
          <div class="col-md-3 mb-2">
            <select class="form-select" name="update_type" id="bulkUpdateType">
              <option value="email" selected>By Email ID</option>
              <option value="extension_id">By Extension ID</option>
              <option value="extension_number">By Extension Number</option>
            </select>
          </div>
          <div class="col-md-5 mb-2">
            <input type="file" class="form-control" name="excel_file" accept=".xlsx" required>
          </div>
          <div class="col-md-4 mb-2">
            <button type="submit" id="bulkUpdateBtn" class="btn btn-success w-100">Bulk Update</button>
          </div>
        </div>
        <small class="text-muted">
          Excel format: <b>Email / Ext ID / Ext Num</b>, <b>Caller ID</b>, <b>Alias (optional)</b><br>
          Example: user@xyz.com,&nbsp;+16127780205,&nbsp;John Desk
        </small>
      </form>
    </div>
  </div>

  <!-- UPDATE REPORT TABLE -->
  <div class="card">
    <div class="card-header">Update Report</div>
    <div class="card-body table-responsive">
      <table class="table table-bordered table-striped" id="reportTable">
        <thead class="table-dark">
          <tr>
            <th>Email / Extension</th>
            <th>Caller ID</th>
            <th>Alias</th>
            <th>Status</th>
            <th>Reason</th>
            <th>Time</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody>
          {% for u in report %}
          <tr>
            <td>{{ u.email or u.extension_id }}</td>
            <td>{{ u.caller_id }}</td>
            <td>{{ u.alias or '-' }}</td>
            <td>{{ 'Pass' if u.success else 'Fail' }}</td>
            <td>{{ u.reason }}</td>
            <td>{{ u.time }}</td>
            <td>{{ u.type }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  function addReportRow(entry) {
    const table = document.querySelector("#reportTable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.identifier}</td>
      <td>${entry.caller_id}</td>
      <td>${entry.alias || '-'}</td>
      <td>${entry.success ? 'Pass' : 'Fail'}</td>
      <td>${entry.reason || ''}</td>
      <td>${entry.time || ''}</td>
      <td>${entry.type || ''}</td>
    `;
    table.prepend(row);
  }

  // -------- Single Update --------
  document.querySelector("#singleUpdateForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById("singleUpdateBtn");

    if (!confirm("Single Update is now processing. Click OK to continue...")) return;

    btn.disabled = true;
    btn.classList.remove("btn-primary");
    btn.classList.add("btn-secondary");
    btn.innerHTML = `
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...
    `;

    const formData = new FormData(form);
    try {
      const res = await fetch("/single_update", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "success" && data.updated_line_keys) {
        data.updated_line_keys.forEach(lk => {
          addReportRow({
            identifier: formData.get("identifier"),
            caller_id: formData.get("caller_id"),
            alias: formData.get("alias"),
            success: lk.success,
            reason: lk.reason,
            time: new Date().toLocaleString(),
            type: "Single"
          });
        });
        showPopup("‚úÖ Update Completed Successfully!");
        form.reset();
      } else {
        alert(data.message || "‚ö†Ô∏è Error updating Caller ID");
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Network or Server Error!");
    } finally {
      resetButton(btn, "Update", "btn-primary");
    }
  });

  // -------- Bulk Update --------
  document.querySelector("#bulkUpdateForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById("bulkUpdateBtn");

    if (!confirm("Bulk Update is now processing. Click OK to continue...")) return;

    btn.disabled = true;
    btn.classList.remove("btn-success");
    btn.classList.add("btn-secondary");
    btn.innerHTML = `
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...
    `;

    const progressContainer = document.createElement("div");
    progressContainer.classList.add("my-3");
    progressContainer.innerHTML = `
      <div class="progress">
        <div id="bulkProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
      </div>
    `;
    form.parentNode.insertBefore(progressContainer, form.nextSibling);

    const progressBar = document.querySelector("#bulkProgress");
    const formData = new FormData(form);
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/bulk_update");

    xhr.upload.addEventListener("progress", evt => {
      if (evt.lengthComputable) {
        const percent = Math.round((evt.loaded / evt.total) * 100);
        progressBar.style.width = percent + "%";
        progressBar.textContent = percent + "%";
      }
    });

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        resetButton(btn, "Bulk Update", "btn-success");

        try {
          const data = JSON.parse(xhr.responseText);
          if (data.status === "success" && data.results) {
            data.results.forEach(user => {
              (user.updated_line_keys || []).forEach(lk => {
                addReportRow({
                  identifier: user.identifier,
                  caller_id: lk.phone_number || "",
                  alias: user.alias || "-",
                  success: lk.success,
                  reason: lk.reason,
                  time: new Date().toLocaleString(),
                  type: "Bulk"
                });
              });
            });
            progressBar.style.width = "100%";
            progressBar.textContent = "100%";
            showPopup("‚úÖ Bulk Update Completed Successfully!");
            form.reset();
          } else {
            alert(data.message || "‚ö†Ô∏è Error in bulk update");
          }
        } catch (err) {
          console.error(err);
          alert("‚ùå Error parsing response from server!");
        }
      }
    };

    xhr.send(formData);
  });

  // ------- Helper: Reset Button -------
  function resetButton(btn, text, styleClass) {
    btn.disabled = false;
    btn.classList.remove("btn-secondary");
    btn.classList.add(styleClass);
    btn.innerHTML = text;
  }

  // ------- Helper: Success Popup -------
  function showPopup(msg) {
    const popup = document.createElement("div");
    popup.textContent = msg;
    popup.style.position = "fixed";
    popup.style.top = "20px";
    popup.style.right = "20px";
    popup.style.background = "#10b981";
    popup.style.color = "white";
    popup.style.padding = "12px 18px";
    popup.style.borderRadius = "8px";
    popup.style.fontWeight = "600";
    popup.style.zIndex = "2000";
    popup.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 4000);
  }
});
</script>

<!-- Real-time SSE Update Listener -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!!window.EventSource) {
    const source = new EventSource("/events");
    source.onmessage = function (event) {
      const data = JSON.parse(event.data);
      console.log("üîî SSE Update:", data);
      if (typeof addReportRow === "function") addReportRow(data);
    };
    source.onerror = err => console.error("SSE connection failed:", err);
  }
});
</script>
{% endblock %}




























