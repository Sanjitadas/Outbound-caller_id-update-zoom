{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Outbound Caller ID Update</h2>

  <!-- Single Update Form -->
  <div class="card mb-4">
    <div class="card-header">Single Update</div>
    <div class="card-body">
      <form id="singleUpdateForm">
        <div class="row">
          <div class="col-md-5 mb-2">
            <input type="email" class="form-control" name="email" placeholder="Email ID" required>
          </div>
          <div class="col-md-5 mb-2">
            <input type="text" class="form-control" name="caller_id" placeholder="Caller ID (+E.164)" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Update</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Update Form -->
  <div class="card mb-4">
    <div class="card-header">Bulk Update (Excel)</div>
    <div class="card-body">
      <form id="bulkUpdateForm" enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-8 mb-2">
            <input type="file" class="form-control" name="excel_file" accept=".xlsx" required>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">Update Bulk</button>
          </div>
        </div>
        <small class="text-muted">Excel rows: email,caller_id (no header)</small>
      </form>
    </div>
  </div>

  <!-- Update Report Table -->
  <div class="card">
    <div class="card-header">Update Report</div>
    <div class="card-body">
      <table class="table table-bordered" id="reportTable">
        <thead>
          <tr>
            <th>Email ID</th>
            <th>Caller ID</th>
            <th>Status</th>
            <th>Reason</th>
            <th>Time</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody>
          {% for u in report %}
          <tr>
            <td>{{ u.email }}</td>
            <td>{{ u.caller_id }}</td>
            <td>{{ 'Pass' if u.success else 'Fail' }}</td>
            <td>{{ u.reason }}</td>
            <td>{{ u.time }}</td>
            <td>{{ u.type }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- JS to handle AJAX submission -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  // Helper to add row to report table
  function addReportRow(entry) {
    const table = document.querySelector("#reportTable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.email}</td>
      <td>${entry.caller_id}</td>
      <td>${entry.success ? 'Pass' : 'Fail'}</td>
      <td>${entry.reason || ''}</td>
      <td>${entry.time || ''}</td>
      <td>${entry.type || 'S'}</td>
    `;
    table.prepend(row); // add on top
  }

  // Single Update
  document.querySelector("#singleUpdateForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;             // Disable button
    submitBtn.classList.add("btn-secondary");
    submitBtn.classList.remove("btn-primary");

    const formData = new FormData(form);

    try {
      const res = await fetch("/single_update", { method: "POST", body: formData });
      const data = await res.json();

      if(data.status === "success" && data.updated_line_keys) {
        data.updated_line_keys.forEach(lk => {
          addReportRow({
            email: data.email,
            caller_id: formData.get("caller_id"),
            success: lk.success,
            reason: lk.reason,
            time: new Date().toLocaleString(),
            type: "S"
          });
        });
        form.reset();
        alert("Single update completed!");
      } else {
        alert(data.message || "Error updating Caller ID");
      }
    } catch(err) {
      alert("Network or server error!");
      console.error(err);
    } finally {
      submitBtn.disabled = false;          // Re-enable button
      submitBtn.classList.add("btn-primary");
      submitBtn.classList.remove("btn-secondary");
    }
  });

  // Bulk Update
  document.querySelector("#bulkUpdateForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;             // Disable button
    submitBtn.classList.add("btn-secondary");
    submitBtn.classList.remove("btn-success");

    const formData = new FormData(form);

    try {
      const res = await fetch("/bulk_update", { method: "POST", body: formData });
      const data = await res.json();

      if(data.status === "success" && data.results) {
        data.results.forEach(user => {
          user.updated_line_keys.forEach(lk => {
            addReportRow({
              email: user.email,
              caller_id: lk.phone_number || formData.get("caller_id") || "",
              success: lk.success,
              reason: lk.reason,
              time: new Date().toLocaleString(),
              type: "B"
            });
          });
        });
        form.reset();
        alert("Bulk update completed!");
      } else {
        alert(data.message || "Error in bulk update");
      }
    } catch(err) {
      alert("Network or server error!");
      console.error(err);
    } finally {
      submitBtn.disabled = false;          // Re-enable button
      submitBtn.classList.add("btn-success");
      submitBtn.classList.remove("btn-secondary");
    }
  });

});
</script>

{% endblock %}






















